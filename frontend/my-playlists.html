<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Playlists - M3U Processor</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∫</text></svg>">
</head>
<body>
    <header>
        <div class="container header-content">
            <a href="/" class="logo">
                <div class="logo-icon">M3U</div>
                <span class="logo-text">M3U Processor</span>
            </a>
            <nav>
                <div id="nav-links">
                    <a href="/">Editor</a>
                    <a href="/view.html">Board</a>
                </div>
                <div id="nav-user" class="nav-user"></div>
            </nav>
        </div>
    </header>

    <main class="container main-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 class="page-title">My Playlists</h1>
                <p class="page-subtitle">Manage your generated playlists</p>
            </div>
            <a href="/" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create New
            </a>
        </div>

        <!-- Loading State -->
        <div id="loading" class="card" style="text-align: center; padding: 3rem;">
            <span class="spinner" style="width: 40px; height: 40px;"></span>
            <p style="margin-top: 1rem; color: var(--text-secondary);">Loading your playlists...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="card empty-state hidden">
            <div class="icon">üìù</div>
            <h3>No playlists yet</h3>
            <p>Create your first playlist to see it here.</p>
            <a href="/" class="btn btn-primary" style="margin-top: 1.5rem;">
                Create Playlist
            </a>
        </div>

        <!-- Playlists Grid -->
        <div id="playlists-container" class="playlists-grid hidden"></div>
    </main>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Playlist</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-token">
                
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="edit-name" class="form-input" placeholder="Playlist name">
                </div>

                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="edit-public">
                        <span>Show on Public Board</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="edit-auto-update" onchange="toggleEditInterval()">
                        <span>Auto-update from source</span>
                    </label>
                </div>

                <div id="edit-interval-section" class="form-group hidden">
                    <label class="form-label">Update Interval</label>
                    <select id="edit-interval" class="form-select">
                        <option value="300">5 minutes</option>
                        <option value="900">15 minutes</option>
                        <option value="1800">30 minutes</option>
                        <option value="3600">1 hour</option>
                        <option value="10800">3 hours</option>
                        <option value="21600">6 hours</option>
                        <option value="43200">12 hours</option>
                        <option value="86400">24 hours</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePlaylist()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Delete Playlist</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="margin-bottom: 1rem;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <p>Are you sure you want to delete this playlist? This action cannot be undone.</p>
                <input type="hidden" id="delete-token">
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p>M3U Processor &copy; 2024 - Process and share your IPTV playlists</p>
    </footer>

    <script src="auth.js"></script>
    <script>
        let playlists = [];

        // Check authentication
        if (!Auth.requireAuth()) {
            // Will redirect to login
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPlaylists();
        });

        async function loadPlaylists() {
            try {
                playlists = await Auth.fetch('/api/my/playlists');
                renderPlaylists();
            } catch (error) {
                Toast.error(error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderPlaylists() {
            const container = document.getElementById('playlists-container');
            const emptyState = document.getElementById('empty-state');

            if (playlists.length === 0) {
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.classList.remove('hidden');

            container.innerHTML = playlists.map(p => `
                <div class="playlist-card">
                    <div class="playlist-info">
                        <div class="playlist-name">${escapeHtml(p.name || 'Unnamed Playlist')}</div>
                        <div class="playlist-meta">
                            <span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px;">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                ${p.total_hits} hits
                            </span>
                            <span class="badge ${p.last_status === 'OK' ? 'badge-success' : p.last_status === 'FAIL' ? 'badge-error' : 'badge-neutral'}">
                                ${p.last_status || 'N/A'}
                            </span>
                            ${p.show_on_board ? '<span class="badge badge-info">Public</span>' : ''}
                            ${p.auto_update ? '<span class="badge badge-warning">Auto-update</span>' : ''}
                        </div>
                    </div>
                    <div class="playlist-actions">
                        <button class="btn btn-ghost btn-sm" onclick="copyUrl('${p.raw_url}')" title="Copy URL">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        <a href="/view.html?token=${p.token}" class="btn btn-ghost btn-sm" title="View">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                        <button class="btn btn-ghost btn-sm" onclick="openEditModal('${p.token}')" title="Edit">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="openDeleteModal('${p.token}')" title="Delete" style="color: var(--error);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url);
            Toast.success('URL copied to clipboard!');
        }

        function openEditModal(token) {
            const playlist = playlists.find(p => p.token === token);
            if (!playlist) return;

            document.getElementById('edit-token').value = token;
            document.getElementById('edit-name').value = playlist.name || '';
            document.getElementById('edit-public').checked = playlist.show_on_board;
            document.getElementById('edit-auto-update').checked = playlist.auto_update;
            document.getElementById('edit-interval').value = playlist.auto_update_interval;
            
            toggleEditInterval();
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function toggleEditInterval() {
            const autoUpdate = document.getElementById('edit-auto-update').checked;
            document.getElementById('edit-interval-section').classList.toggle('hidden', !autoUpdate);
        }

        async function savePlaylist() {
            const token = document.getElementById('edit-token').value;
            const data = {
                name: document.getElementById('edit-name').value,
                show_on_board: document.getElementById('edit-public').checked,
                auto_update: document.getElementById('edit-auto-update').checked,
                auto_update_interval: parseInt(document.getElementById('edit-interval').value)
            };

            try {
                await Auth.fetch(`/api/my/playlists/${token}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                Toast.success('Playlist updated!');
                closeEditModal();
                loadPlaylists();
            } catch (error) {
                Toast.error(error.message);
            }
        }

        function openDeleteModal(token) {
            document.getElementById('delete-token').value = token;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
        }

        async function confirmDelete() {
            const token = document.getElementById('delete-token').value;

            try {
                await Auth.fetch(`/api/my/playlists/${token}`, {
                    method: 'DELETE'
                });
                Toast.success('Playlist deleted!');
                closeDeleteModal();
                loadPlaylists();
            } catch (error) {
                Toast.error(error.message);
            }
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                closeDeleteModal();
            }
        });

        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeEditModal();
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>
